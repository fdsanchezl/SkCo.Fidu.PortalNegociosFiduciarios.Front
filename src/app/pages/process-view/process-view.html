<div class="card">
    <div class="p-6">
        <p-toast />
        <p-table
            #dt
            [value]="retiros"
            [rows]="10"
            [lazy]="true"
            (onLazyLoad)="loadRetiros($event)"
            [paginator]="true"
            [globalFilterFields]="['id', 'cuentaOrigen.numero', 'cuentaOrigen.tipo', 'estado']"
            [tableStyle]="{ 'min-width': '75rem' }"
            [rowHover]="true"
            dataKey="id"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
            [totalRecords]="totalRecords"
            [loading]="loading"
            [showCurrentPageReport]="true"
            [rowsPerPageOptions]="[10, 20, 30]"
        >
            <ng-template #caption>
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold m-0 text-gray-800 dark:text-gray-100">Flujos de Retiro</h1>
                    <p-iconfield>
                        <p-inputicon class="pi pi-search" />
                        <input pInputText type="text" (input)="dt.filterGlobal($event.target, 'contains')" placeholder="Buscar..." />
                    </p-iconfield>
                </div>
            </ng-template>
            <ng-template #header>
                <tr>
                    <th pSortableColumn="fechaSolicitud" style="min-width:12rem">
                        Fecha <p-sortIcon field="fechaSolicitud" />
                    </th>
                    <th style="min-width:16rem">Cuenta Origen</th>
                    <th pSortableColumn="monto" style="min-width:10rem">
                        Monto <p-sortIcon field="monto" />
                    </th>
                    <th pSortableColumn="estado" style="min-width:10rem">
                        Estado <p-sortIcon field="estado" />
                    </th>
                    <th style="min-width:8rem">Acciones</th>
                </tr>
            </ng-template>
            <ng-template #body let-retiro>
                <tr>
                    <td>{{ retiro.fechaSolicitud | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ retiro.cuentaOrigen.tipo }} - {{ retiro.cuentaOrigen.numero }}</td>
                    <td>{{ retiro.monto | currency: 'USD' : 'symbol' : '1.0-0' }}</td>
                    <td><p-tag [value]="retiro.estado" [severity]="getSeverity(retiro.estado)" /></td>
                    <td>
                        <p-button 
                            *ngIf="retiro.estado === 'Pendiente' || retiro.estado === 'En Revisión'"
                            icon="pi pi-pencil" 
                            [rounded]="true" 
                            [outlined]="true" 
                            (click)="openApprovalDialog(retiro)" 
                        />
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<p-dialog [(visible)]="approvalDialogVisible" [style]="{ width: '450px' }" header="Gestionar Aprobación" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-4 mt-4">
            <label for="comment" class="block font-bold">Comentario</label>
            <textarea id="comment" pTextarea [(ngModel)]="approvalComment" required rows="3" cols="20" placeholder="Añade un comentario..."></textarea>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Rechazar" icon="pi pi-times" severity="danger" (click)="rejectRetiro()" />
        <p-button label="Aprobar" icon="pi pi-check" severity="success" (click)="approveRetiro()" />
    </ng-template>
</p-dialog>
